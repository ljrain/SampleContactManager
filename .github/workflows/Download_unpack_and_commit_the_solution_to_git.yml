# GitHub Actions workflow to export a Power Platform solution
# - Exports BOTH Unmanaged and Managed solution ZIPs
# - Validates ZIP integrity to avoid "Central Directory corrupt" errors
# - Unpacks both versions into source-controlled folders
# - Commits and pushes changes to a new auto-prefixed branch

name: Export Power Platform Solution (Managed + Unmanaged)

on:
  workflow_dispatch:
    inputs:
      environment_url:
        description: "Dataverse environment URL (e.g. https://org.crm.dynamics.com)"
        required: true
        type: string
      solution_name:
        description: "Solution UNIQUE name in Dataverse (not display name)"
        required: true
        type: string
      source_branch:
        description: "Branch to start from"
        required: true
        default: "main"
        type: string
      target_branch:
        description: "Target branch (leave blank to auto-generate)"
        required: false
        default: ""
        type: string
      commit_message:
        description: "Git commit message"
        required: true
        default: "Export Power Platform solution (managed + unmanaged)"
        type: string
      user_name:
        description: "Git commit username"
        required: true
        default: "github-actions[bot]"
        type: string

permissions:
  contents: write

jobs:
  export-unpack-commit:
    runs-on: ubuntu-latest
    environment: MAIN  # GitHub Environment containing CLIENT_ID / CLIENT_SECRET / TENANT_ID

    steps:
      # 1. Checkout the source branch
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}

      # 2. Resolve target branch name (auto-generate if not provided)
      - name: Resolve target branch
        shell: bash
        run: |
          set -euo pipefail
          SOL="${{ inputs.solution_name }}"
          SRC="${{ inputs.source_branch }}"
          IN_TARGET="${{ inputs.target_branch }}"
          TS="$(date +'%Y%m%d-%H%M')"
          SAFE_SOL="$(echo "$SOL" | sed -E 's/[^a-zA-Z0-9_-]+/-/g' | sed -E 's/^-+|-+$//g')"
          if [[ -z "$IN_TARGET" ]]; then
            TARGET="$SAFE_SOL-$TS"
          else
            TARGET="$IN_TARGET"
          fi
          echo "SOURCE_BRANCH=$SRC" >> "$GITHUB_ENV"
          echo "TARGET_BRANCH=$TARGET" >> "$GITHUB_ENV"
          git checkout -b "$TARGET"

      # 3. Validate required secrets exist (values are NOT printed)
      - name: Validate secrets
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
        run: |
          set -euo pipefail
          missing=()
          [[ -z "$CLIENT_ID" ]] && missing+=("CLIENT_ID")
          [[ -z "$CLIENT_SECRET" ]] && missing+=("CLIENT_SECRET")
          [[ -z "$TENANT_ID" ]] && missing+=("TENANT_ID")
          if (( ${#missing[@]} > 0 )); then
            echo "Missing required secrets: ${missing[*]}"
            exit 1
          fi

      # 4. Install Power Platform CLI tools (recommended)
      - name: Install Power Platform tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      # 5. Export UNMANAGED solution ZIP
      - name: Export unmanaged solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-name: ${{ inputs.solution_name }}
          solution-output-file: out/exported/${{ inputs.solution_name }}.zip
          cloud: UsGov
          overwrite: true

      # 6. Export MANAGED solution ZIP
      - name: Export managed solution
        uses: microsoft/powerplatform-actions/export-solution@v1
        with:
          environment-url: ${{ inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-name: ${{ inputs.solution_name }}
          solution-output-file: out/exported/${{ inputs.solution_name }}_managed.zip
          managed: true
          cloud: UsGov
          overwrite: true

      # 7. ZIP integrity validation (prevents Central Directory corrupt errors)
      - name: Validate exported ZIPs
        shell: bash
        run: |
          set -euo pipefail
          ls -al out/exported
          unzip -t "out/exported/${{ inputs.solution_name }}.zip" > /dev/null
          unzip -t "out/exported/${{ inputs.solution_name }}_managed.zip" > /dev/null
          echo "ZIP integrity validated"

      # 8. Unpack UNMANAGED solution
      - name: Unpack unmanaged solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: out/exported/${{ inputs.solution_name }}.zip
          solution-folder: out/solutions/${{ inputs.solution_name }}/unmanaged
          solution-type: Unmanaged
          overwrite-files: true

      # 9. Unpack MANAGED solution
      - name: Unpack managed solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: out/exported/${{ inputs.solution_name }}_managed.zip
          solution-folder: out/solutions/${{ inputs.solution_name }}/managed
          solution-type: Managed
          overwrite-files: true

      # 10. Copy unpacked solutions into repo-controlled folders
      - name: Copy unpacked solutions into repo
        shell: bash
        run: |
          set -euo pipefail
          SOL="${{ inputs.solution_name }}"
          rm -rf "solutions/$SOL"
          mkdir -p "solutions/$SOL"
          cp -R "out/solutions/$SOL"/* "solutions/$SOL/"

      # 11. Commit changes
      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "${{ inputs.user_name }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          git commit -m "${{ inputs.commit_message }}" || echo "No changes to commit"

      # 12. Push branch
      - name: Push branch
        shell: bash
        run: |
          set -euo pipefail
          git push origin "$TARGET_BRANCH"
