name: Download, unpack, and commit solution to git

run-name: Getting ${{ github.event.inputs.solution_name }} from pipelines host and committing

on:
  workflow_dispatch:
    inputs:
      artifact_url:
        description: "Dataverse deployment artifact URL (…/deploymentartifacts(<id>)/artifactfile/$value)"
        required: true
        type: string
      solution_name:
        description: "Name of the Dataverse solution"
        required: true
        type: string
      user_name:
        description: "User name for git commit"
        required: true
        type: string
      source_branch:
        description: "Source branch for commit"
        required: true
        type: string
      target_branch:
        description: "Optional branch to create"
        required: false
        type: string
      commit_message:
        description: "Commit message"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: pipelines-export-${{ github.repository }}
  cancel-in-progress: false

jobs:
  export-unpack-commit:
    runs-on: ubuntu-latest

    # ✅ THIS IS THE CRITICAL FIX
    environment: MAIN

    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      TENANT_ID: ${{ secrets.TENANT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}

    steps:
      - name: Install Power Platform Tools
        uses: microsoft/powerplatform-actions/actions-install@v1

      - name: Normalize branches
        id: branches
        shell: bash
        run: |
          SB="$(echo '${{ github.event.inputs.source_branch }}' | xargs)"
          TB="$(echo '${{ github.event.inputs.target_branch }}' | xargs)"

          if [[ "$SB" == "Source Branch" || "$SB" == "SourceBranch" || -z "$SB" ]]; then
            SB="main"
          fi

          echo "source_branch=$SB" >> $GITHUB_OUTPUT
          echo "target_branch=$TB" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.branches.outputs.source_branch }}
          fetch-depth: 1

      - name: Create target branch (if specified)
        if: ${{ steps.branches.outputs.target_branch != '' }}
        shell: pwsh
        run: |
          git checkout -b "${{ steps.branches.outputs.target_branch }}"

      - name: Download solution from pipelines artifact
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:CLIENT_ID) `
           -or [string]::IsNullOrWhiteSpace($env:TENANT_ID) `
           -or [string]::IsNullOrWhiteSpace($env:CLIENT_SECRET)) {
            throw "Missing required secrets: CLIENT_ID, TENANT_ID, CLIENT_SECRET"
          }

          $artifactUrl = "${{ github.event.inputs.artifact_url }}"
          $uri = [System.Uri]$artifactUrl
          $dataverseHost = "$($uri.Scheme)://$($uri.Host)"

          $tokenUri = "https://login.microsoftonline.com/$($env:TENANT_ID)/oauth2/v2.0/token"

          $body = @{
            client_id     = $env:CLIENT_ID
            client_secret = $env:CLIENT_SECRET
            grant_type    = "client_credentials"
            scope         = "$dataverseHost/.default"
          }

          $oauthReq = Invoke-RestMethod `
            -Method Post `
            -Uri $tokenUri `
            -Body $body `
            -ContentType "application/x-www-form-urlencoded"

          $headers = @{
            Authorization = "Bearer $($oauthReq.access_token)"
            "Content-Type" = "application/json"
          }

          # Managed
          $respManaged = Invoke-RestMethod -Uri $artifactUrl -Method GET -Headers $headers
          $bytesManaged = [Convert]::FromBase64String($respManaged.value)
          [IO.File]::WriteAllBytes("${{ github.event.inputs.solution_name }}_managed.zip", $bytesManaged)

          # Unmanaged
          $unmanagedUrl = $artifactUrl.Replace("artifactfile", "artifactfileunmanaged")
          $respUnmanaged = Invoke-RestMethod -Uri $unmanagedUrl -Method GET -Headers $headers
          $bytesUnmanaged = [Convert]::FromBase64String($respUnmanaged.value)
          [IO.File]::WriteAllBytes("${{ github.event.inputs.solution_name }}.zip", $bytesUnmanaged)

      - name: Unpack unmanaged solution
        uses: microsoft/powerplatform-actions/unpack-solution@v1
        with:
          solution-file: "${{ github.event.inputs.solution_name }}.zip"
          solution-folder: "${{ github.repository }}"
          solution-type: Unmanaged
          process-canvas-apps: false
          overwrite-files: true

      - name: Commit changes
        shell: pwsh
        run: |
          Remove-Item *.zip -Force -ErrorAction SilentlyContinue
          git config user.name "${{ github.event.inputs.user_name }}"
          git config user.email "github-actions@users.noreply.github.com"
          git pull
          git add -A
          git commit -m "${{ github.event.inputs.commit_message }}" --allow-empty

      - name: Push changes
        shell: pwsh
        run: |
          if ("${{ steps.branches.outputs.target_branch }}" -ne "") {
            git push origin "${{ steps.branches.outputs.target_branch }}"
          } else {
            git push origin "${{ steps.branches.outputs.source_branch }}"
          }
