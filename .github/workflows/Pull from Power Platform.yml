name: Export solution from Power Platform (direct)

run-name: Export ${{ github.event.inputs.solution_name }} from ${{ github.event.inputs.environment_url }}

on:
  workflow_dispatch:
    inputs:
      environment_url:
        description: "Dataverse environment URL (ex: https://yourenv.crm.dynamics.com)"
        required: true
        default: "https://lougcc.crm9.dynamics.com/"
        type: string
      solution_name:
        description: "Solution unique name in Dataverse"
        required: true
        default: "sample"
        type: string
      source_branch:
        description: "Branch to start from"
        required: false
        default: "main"
        type: string
      target_branch:
        description: "Branch to commit into (optional; defaults to source_branch)"
        required: false
        default: ""
        type: string
      commit_message:
        description: "Commit message"
        required: false
        default: "Export solution from Power Platform"
        type: string
      solution_type:
        description: "Unmanaged or Managed"
        required: false
        default: "Unmanaged"
        type: choice
        options:
          - Unmanaged
          - Managed

permissions:
  contents: write

jobs:
  export-unpack-commit:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.source_branch }}

      - name: Resolve branch defaults
        shell: pwsh
        run: |
          $source = "${{ github.event.inputs.source_branch }}"
          if ([string]::IsNullOrWhiteSpace($source)) { $source = "main" }

          $target = "${{ github.event.inputs.target_branch }}"
          if ([string]::IsNullOrWhiteSpace($target)) { $target = $source }

          "SOURCE_BRANCH=$source" | Out-File -FilePath $env:GITHUB_ENV -Append
          "TARGET_BRANCH=$target" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create target branch (if different)
        shell: pwsh
        run: |
          if ("${{ env.TARGET_BRANCH }}" -ne "${{ env.SOURCE_BRANCH }}") {
            git checkout -b "${{ env.TARGET_BRANCH }}" "${{ env.SOURCE_BRANCH }}"
          }

      # This is the direct export pattern you referenced:
      # microsoft/powerplatform-actions/export-solution@v0 with environment-url/app-id/client-secret/tenant-id/solution-name [1](https://teams.microsoft.com/l/message/19:meeting_ZWI2ZWU0NzMtN2EyYi00MDc2LTljYTktZWMwYzBmN2M0YzAz@thread.v2/1759162120322?context=%7B%22contextType%22:%22chat%22%7D)[2](https://microsoft-my.sharepoint.com/personal/tidarius_microsoft_com/_layouts/15/Doc.aspx?sourcedoc=%7B2C79661B-A00C-45D2-96CB-DDF9143922EB%7D&file=ALM_GitHubActions_wPP%201.vsdx&action=default&mobileredirect=true&DefaultItemOpen=1)[3](https://microsoft-my.sharepoint.com/personal/tidarius_microsoft_com/_layouts/15/Doc.aspx?sourcedoc=%7B467298BA-9545-4F3D-9CD6-BA27BEB27612%7D&file=ALM_GitHubActions_wPP.vsdx&action=default&mobileredirect=true&DefaultItemOpen=1)
      - name: Export solution
        uses: microsoft/powerplatform-actions/export-solution@v0
        with:
          environment-url: ${{ github.event.inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          solution-name: ${{ github.event.inputs.solution_name }}
          solution-output-file: out/exported/${{ github.event.inputs.solution_name }}.zip
          solution-type: ${{ github.event.inputs.solution_type }}

      - name: Unpack solution
        uses: microsoft/powerplatform-actions/unpack-solution@v0
        with:
          solution-file: out/exported/${{ github.event.inputs.solution_name }}.zip
          solution-folder: solutions/${{ github.event.inputs.solution_name }}
          solution-type: ${{ github.event.inputs.solution_type }}
          overwrite-files: true

      - name: Commit changes
        shell: pwsh
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add --all
          git commit -m "${{ github.event.inputs.commit_message }}" --allow-empty

      - name: Push branch
        shell: pwsh
        run: |
          git push origin "${{ env.TARGET_BRANCH }}"
