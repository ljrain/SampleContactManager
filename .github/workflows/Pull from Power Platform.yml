name: Export solution from Power Platform (direct)

on:
  workflow_dispatch:
    inputs:
      environment_url:
        description: Dataverse environment URL (e.g. https://org.crm9.dynamics.com)
        required: true
        type: string
      solution_name:
        description: Solution unique name
        required: true
        type: string
      source_branch:
        description: Branch to start from
        required: true
        default: main
        type: string
      commit_message:
        description: Commit message
        required: true
        default: Export solution from Power Platform
        type: string
      user_name:
        description: Git commit username
        required: true
        default: github-actions[bot]
        type: string

permissions:
  contents: write

jobs:
  export-unpack-commit:
    runs-on: windows-latest
    environment: MAIN

    steps:
      - name: Checkout source branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.source_branch }}

      - name: Resolve branches (auto-prefix)
        shell: pwsh
        run: |
          $source = '${{ github.event.inputs.source_branch }}'
          if ([string]::IsNullOrWhiteSpace($source)) {
            $source = 'main'
          }

          $solution = '${{ github.event.inputs.solution_name }}'
          $stamp = Get-Date -Format 'yyyyMMdd-HHmm'
          $safe = ($solution -replace '[^a-zA-Z0-9._-]', '-').Trim('-')
          $target = "$safe-$stamp"

          "SOURCE_BRANCH=$source" | Out-File $env:GITHUB_ENV -Append
          "TARGET_BRANCH=$target" | Out-File $env:GITHUB_ENV -Append

          git checkout -b $target

      - name: Validate environment secrets
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
        run: |
          $missing = @()
          if ([string]::IsNullOrWhiteSpace($env:CLIENT_ID)) { $missing += 'CLIENT_ID' }
          if ([string]::IsNullOrWhiteSpace($env:CLIENT_SECRET)) { $missing += 'CLIENT_SECRET' }
          if ([string]::IsNullOrWhiteSpace($env:TENANT_ID)) { $missing += 'TENANT_ID' }

          if ($missing.Count -gt 0) {
            throw "Missing environment secrets: $($missing -join ', ')"
          }

      - name: WhoAmI (auth preflight)
        uses: microsoft/powerplatform-actions/who-am-i@v0
        with:
          environment-url: ${{ github.event.inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          cloud: UsGov

      - name: Export solution
        uses: microsoft/powerplatform-actions/export-solution@v0
        with:
          environment-url: ${{ github.event.inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          cloud: UsGov
          solution-name: ${{ github.event.inputs.solution_name }}
          solution-output-file: out/exported.zip
          solution-type: Unmanaged

      - name: Unpack solution
        uses: microsoft/powerplatform-actions/unpack-solution@v0
        with:
          solution-file: out/exported.zip
          solution-folder: solutions/${{ github.event.inputs.solution_name }}
          solution-type: Unmanaged
          overwrite-files: true

      - name: Commit changes
        shell: pwsh
        run: |
          git config user.name "${{ github.event.inputs.user_name }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          git commit -m "${{ github.event.inputs.commit_message }}" --allow-empty

      - name: Push branch
        shell: pwsh
        run: |
          git push origin $env:TARGET_BRANCH
