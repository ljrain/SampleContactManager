name: Export solution from Power Platform (direct)

run-name: Export ${{ github.event.inputs.solution_name }}

on:
  workflow_dispatch:
    inputs:
      environment_url:
        description: Dataverse environment URL (e.g. https://xyz.crm9.dynamics.com)
        required: true
        type: string
      solution_name:
        description: Solution unique name in Dataverse
        required: true
        type: string
      source_branch:
        description: Branch to start from
        required: true
        default: main
        type: string
      target_branch:
        description: Branch to commit into (leave blank to auto-generate)
        required: false
        type: string
      solution_type:
        description: Unmanaged or Managed export
        required: true
        type: choice
        options:
          - Unmanaged
          - Managed
      commit_message:
        description: Commit message
        required: true
        default: Export solution from Power Platform
        type: string
      user_name:
        description: Git commit username
        required: true
        default: github-actions[bot]
        type: string

permissions:
  contents: write

jobs:
  export-unpack-commit:
    runs-on: windows-latest

    # ðŸ”´ REQUIRED so environment secrets are injected
    environment: MAIN

    steps:
      # ------------------------------
      # Checkout source branch
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.source_branch }}

      # ------------------------------
      # Resolve branches (auto-prefix)
      # ------------------------------
      - name: Resolve branches
        shell: pwsh
        run: |
          $source = "${{ github.event.inputs.source_branch }}"
          if ([string]::IsNullOrWhiteSpace($source)) { $source = "main" }

          $targetInput = "${{ github.event.inputs.target_branch }}"
          $solution = "${{ github.event.inputs.solution_name }}"

          $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
          $safeSolution = ($solution -replace '[^a-zA-Z0-9._-]', '-').Trim('-')

          if ([string]::IsNullOrWhiteSpace($targetInput)) {
            $target = "$safeSolution-$timestamp"
          } else {
            $target = $targetInput
          }

          "SOURCE_BRANCH=$source" | Out-File -FilePath $env:GITHUB_ENV -Append
          "TARGET_BRANCH=$target" | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "SOURCE_BRANCH=$source"
          Write-Host "TARGET_BRANCH=$target"

      # ------------------------------
      # Create target branch
      # ------------------------------
      - name: Create target branch
      - shell: pwsh
        run: |
          git checkout -b $env:TARGET_BRANCH

      # ------------------------------
      # Validate secrets injected
      # ------------------------------
      - name: Validate auth secrets
        shell: pwsh
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
        run: |
          $missing = @()
          if ([string]::IsNullOrWhiteSpace($env:CLIENT_ID))     { $missing += "CLIENT_ID" }
          if ([string]::IsNullOrWhiteSpace($env:CLIENT_SECRET)) { $missing += "CLIENT_SECRET" }
          if ([string]::IsNullOrWhiteSpace($env:TENANT_ID))     { $missing += "TENANT_ID" }

          if ($missing.Count -gt 0) {
            throw "Missing environment secrets: $($missing -join ', ')"
          }

          Write-Host "Environment secrets successfully injected."

      # ------------------------------
      # WhoAmI (auth preflight)
      # ------------------------------
      - name: WhoAmI (Dataverse auth check)
        uses: microsoft/powerplatform-actions/who-am-i@v0
        with:
          environment-url: ${{ github.event.inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          cloud: UsGov

      # ------------------------------
      # Export solution
      # ------------------------------
      - name: Export solution
        uses: microsoft/powerplatform-actions/export-solution@v0
        with:
          environment-url: ${{ github.event.inputs.environment_url }}
          app-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}
          cloud: UsGov
          solution-name: ${{ github.event.inputs.solution_name }}
          solution-output-file: out/exported.zip
          solution-type: ${{ github.event.inputs.solution_type }}

      # ------------------------------
      # Unpack solution
      # ------------------------------
      - name: Unpack solution
        uses: microsoft/powerplatform-actions/unpack-solution@v0
        with:
          solution-file: out/exported.zip
          solution-folder: solutions/${{ github.event.inputs.solution_name }}
          solution-type: ${{ github.event.inputs.solution_type }}
          overwrite-files: true

      # ------------------------------
      # Commit changes
      # ------------------------------
      - name: Commit changes
        shell: pwsh
        run: |
          git config user.name "${{ github.event.inputs.user_name }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add .
          git commit -m "${{ github.event.inputs.commit_message }}" --allow-empty

      # ------------------------------
      # Push branch
      # ------------------------------
      - name: Push branch
        shell: pwsh
        run: |
          git push origin $env:TARGET_BRANCH
