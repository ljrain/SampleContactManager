name: Export solution from Power Platform (direct)

run-name: Export ${{ github.event.inputs.solution_name }} from ${{ github.event.inputs.environment_url }}

on:
  workflow_dispatch:
    inputs:
      environment_url:
        description: "Dataverse environment URL (e.g., https://yourenv.crm9.dynamics.com)"
        required: true
        type: string
      solution_name:
        description: "Solution unique name in Dataverse"
        required: true
        type: string
      source_branch:
        description: "Branch to start from"
        required: true
        default: "main"
        type: string
      target_branch:
        description: "Branch to commit into (optional; if blank, auto-generated)"
        required: false
        default: ""
        type: string
      solution_type:
        description: "Unmanaged or Managed export"
        required: true
        default: "Unmanaged"
        type: choice
        options:
          - Unmanaged
          - Managed
      commit_message:
        description: "Commit message"
        required: true
        default: "Export solution from Power Platform"
        type: string
      user_name:
        description: "Git commit username"
        required: true
        default: "github-actions[bot]"
        type: string

permissions:
  contents: write

jobs:
  export-unpack-commit:
    runs-on: windows-latest

    # IMPORTANT: this must match your GitHub Environment name where secrets live
    environment: MAIN

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.source_branch }}

      - name: Resolve branches (auto-prefix target branch)
        shell: pwsh
        run: |
          $source = "${{ github.event.inputs.source_branch }}"
          if ([string]::IsNullOrWhiteSpace($source)) { $source = "main" }

          $target = "${{ github.event.inputs.target_branch }}"

          if ([string]::IsNullOrWhiteSpace($target)) {
            $sol = "${{ github.event.inputs.solution_name }}"
            # yyyyMMdd-HHmm
            $stamp = (Get-Date).ToString("yyyyMMdd-HHmm")
            # make a safe branch name (strip spaces + illegal chars)
            $safeSol = ($sol -replace '[^a-zA-Z0-9._-]', '-').Trim('-')
            $target = "$safeSol-$stamp"
          }

          "SOURCE_BRANCH=$source" | Out-File -FilePath $env:GITHUB_ENV -Append
          "TARGET_BRANCH=$target" | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "SOURCE_BRANCH=$source"
          Write-Host "TARGET_BRANCH=$target"

      - name: Create target branch
        shell: pwsh
        run: |
          git checkout -b $env:TARGET_BRANCH

      - name: Validate secrets injected (no secret values printed)
        shell: pwsh
        run: |
          $missing = @()
          if ([string]::IsNullOrWhiteSpace("${{ secrets.CLIENT_ID }}")) { $missing += "CLIENT_ID" }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.CLIENT_SECRET }}")) { $missing += "CLIENT_SECRET" }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.TENANT_ID }}")) { $missing += "TENANT_ID" }
          if ($missing.Count -gt 0) {
