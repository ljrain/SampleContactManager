name: Export solution from Power Platform (direct)

run-name: Export ${{ github.event.inputs.solution_name }} from ${{ github.event.inputs.environment_url }}

on:
  workflow_dispatch:
    inputs:
      environment_url:
        description: "Dataverse environment URL (example: https://your-env.crm9.dynamics.com)"
        required: true
        type: string
      solution_name:
        description: "Solution unique name in Dataverse"
        required: true
        type: string
      source_branch:
        description: "Branch to start from"
        required: true
        default: "main"
        type: string
      target_branch:
        description: "Branch to commit into (optional; defaults to source_branch if blank)"
        required: false
        default: ""
        type: string
      solution_type:
        description: "Unmanaged or Managed export"
        required: true
        default: "Unmanaged"
        type: choice
        options:
          - Unmanaged
          - Managed
      commit_message:
        description: "Commit message"
        required: true
        default: "Export solution from Power Platform"
        type: string
      user_name:
        description: "Git commit username"
        required: true
        default: "github-actions[bot]"
        type: string

permissions:
  contents: write

jobs:
  export-unpack-commit:
    runs-on: windows-latest

    # IMPORTANT: This must match your GitHub Environment name where secrets live
    environment: MAIN

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.source_branch }}

      - name: Resolve branch defaults
        shell: pwsh
        run: |
          $source = "${{ github.event.inputs.source_branch }}"
          if ([string]::IsNullOrWhiteSpace($source)) { $source = "main" }

          $target = "${{ github.event.inputs.target_branch }}"
          if ([string]::IsNullOrWhiteSpace($target)) { $target = $source }

          "SOURCE_BRANCH=$source" | Out-File -FilePath $env:GITHUB_ENV -Append
          "TARGET_BRANCH=$target" | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "SOURCE_BRANCH=$source"
          Write-Host "TARGET_BRANCH=$target"

      - name: Create target branch (if different)
        shell: pwsh
        run: |
          if ($env:TARGET_BRANCH -ne $env:SOURCE_BRANCH) {
            git checkout -b $env:TARGET_BRANCH $env:SOURCE_BRANCH
          } else {
            git checkout $env:SOURCE_BRANCH
          }

      # Optional, SAFE validation: confirms secrets are injected (does not print values)
      - name: Validate auth secrets injected (safe)
        shell: pwsh
        run: |
          $missing = @()
          if ([string]::IsNullOrWhiteSpace("${{ secrets.CLIENT_ID }}")) { $missing += "CLIENT_ID" }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.CLIENT_SECRET }}")) { $missing += "CLIENT_SECRET" }
